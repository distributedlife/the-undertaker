/*                                 ▄▄▌█▓▓▓▓█▌▄▄
                                ▄▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▄
                               ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌
                              ▓▓▓▓▓▓▓▓▓▓▀▀█▓▓▓▓▓▓▓▓⌐
                              ▓▓▓▓▓▓▓▓▓▒░╠▒▌▓▓▓▓▓▓▓▌
                             ]▓▓▓▓▓▓▓▓▓▌▌▌▓▓▓▓▓▓▓▓▓▌
                  ╗▄▌█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▄▄
                ╓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▄
                ▀▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▒▀▓▓▓▓▓▓▓▓█▓▓▓▌╣▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌
                 ▀▓▓▓▓▓▓▓▓▓▓▓██▓▌▒▒▀▀▒▀▓▌▀█▌▌▒▀▌▌▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓
                  ╙█▓▓▓▓▓▓▓▓▓▌▒▓▌▌▒▒▌▒▌▓▌▒█▌▒▀▌▒▀▌▓▓▓▓▓▓▓▓▓▓▓▓▓`
                    ╙▀▓▓▓▓▓▓▓▌▌▓▓▌▌▓╣▓█▀▀▀▀█▓╬▌▒▀▓▓▓▓▓▓▓▓▓▓▓▓▀
                       ▀▓▓▓▓▓▓▌▌▓▓▌▌▌▒▀▀▒▒▒▀╬▀▒▌▌▓▓▓▓▓▓▓▓▓▓
                      ╣▓▓▓▓▓▓▓▓▓▓▓▌▌▌▒▒╣▀▒╬╬▒▒▌▀▌▓▓▓▓▓▓▓▓▓▓▄
                     ╔▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▒▒╬╬╬▒▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓╦
                    ▐▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▌▓▓▓▓▓▓▌▓▓▓▓▓▓▓▓▓▓▓▓▌
                   ╫▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▌▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓╬
                   ╫▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▓▓▌▀▀▀▌▌▀▒▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓,
                  ▄▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▌▀▌▀▌▀▒▀▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌
              ╔▄▄▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▒▀▒▀▒▒▀▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▄▄
             ▄▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▌▒▒▀▒▒╬▌▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▄▄
         ,▄▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▌▒▒▒▒▒▀▒▀▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█▄
       ▄▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▀▀▒╬▒╬╬░░░╬▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓█▌▓▓▓▓▓▓▓▓▓▓▓▓▌
      ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▒░░░░╠╬╬░░░░╠╬▒▀▓▓▓▓▓▓▓▌▓▓▓▌▌▓▓▓▓▓▓▓▓▓▓▓▓▓▌
     ╫▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▀▓▓▀▀╬▒╬░░░░░╬▒╬╬░░░░░░╬╬╬╬▓▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓Q
    ▄▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌╬▒╬░╠╬░░░░░░░╟▒╬╬░░░░░╠╠╠░╠▓▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
   ╓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▌░░░░╠░░░░░░╠░╟╬╬╬░░░░░░░░░╢▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▓▓
   ▓▓▀▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌╠░░░░░░░░░╠╣╬╣▒▒▒╠░░░░░░░░╣▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▓▓▓▓▓▓▓▓
  ▓▓▓▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓╬╠░░░░░░░░╟╬░╟▒▒▒╬░░░░░░░╠╣▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓╕
 ╫▓▓▓▓▌▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌╬░░░░░░░╬╣▒╠╠▀▌▒╬╢░░░░░░╠╣▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓µ
╓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒╠░░░░░╠╬╬╬░░╣╬▀▒╬╬░░░░░╠╫▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓µ
▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌╠░░░╠╬╬╬╠░░╬╬▒▒▒╬╠░░░╠╫▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▌▓▓ */

const { fromJS } = require('immutable');
const trim = require('lodash/trim');
const isString = require('lodash/isString');

const emptyMap = fromJS({});
const emptyArray = fromJS([]);

class TheUndertaker {
  static convertToOriginalType(value) {
    const bool = value.match(/(true)|(false)/);
    if (bool) {
      return value === 'true';
    }
    const matches = value.match(/"(.+)"/);
    return (matches && matches[1]) || Number(value);
  }

  static setListInTree(tree, head, tail, updater) {
    const [key, address] = head.split('|');
    const [elementKey, elementValue] = address.split(':');
    const realElementValue = TheUndertaker.convertToOriginalType(elementValue);
    const elements = tree.get(key, emptyArray);
    const elementIndex = elements.findIndex((e) => e.get(elementKey) === realElementValue);
    const elementExists = elementIndex !== -1;

    if (elementExists) {
      return tree.set(key, elements.update(
        elementIndex,
        (element) => TheUndertaker.undertake(element, tail, updater)
      ));
    }

    const newMap = fromJS({ [elementKey]: realElementValue });
    return tree.set(key, elements.push(TheUndertaker.undertake(newMap, tail, updater)));
  }

  static undertake(tree, path, updater) {
    const [head, ...tail] = path;

    if (!tail.length) {
      return tree.update(head, (currentValue) => {
        const newValue = updater(currentValue);
        return isString(newValue) ? trim(newValue) : newValue;
      });
    }

    if (head.includes('|')) {
      return TheUndertaker.setListInTree(tree, head, tail, updater);
    }

    const indexOfFirstArrayInPath = path.findIndex((element) => element.includes('|'));
    const simplePath = path.slice(0, indexOfFirstArrayInPath);
    const remainingPath = path.slice(indexOfFirstArrayInPath);
    return tree.setIn(
      simplePath,
      TheUndertaker.undertake(tree.getIn(simplePath, emptyMap), remainingPath, updater)
    );
  }
}

module.exports = TheUndertaker.undertake;
